define("mod_kanban/mutations",["exports","core/ajax"],(function(_exports,_ajax){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};return _exports.default=class{init(stateManager){stateManager.addUpdateTypes({discussionput:this._discussionPut,discussiondelete:this._discussionDelete})}_discussionPut(stateManager,name,fields){stateManager.setReadOnly(!1);const cardid=parseInt(fields.kanban_card);void 0===stateManager.state.discussions.get(cardid)&&stateManager.state.discussions.set(cardid,{id:cardid,values:[]}),stateManager.state.discussions.get(cardid).values[fields.id]=fields,stateManager.eventsToPublish.push({eventName:"".concat(name,":updated"),eventData:fields,action:"updated"}),stateManager.setReadOnly(!1)}_discussionDelete(stateManager,name,fields){stateManager.setReadOnly(!1);const cardid=parseInt(fields.kanban_card);void 0!==stateManager.state.discussions.get(cardid)&&(delete stateManager.state.discussions.get(cardid).values[fields.id],stateManager.eventsToPublish.push({eventName:"".concat(name,":updated"),eventData:fields,action:"updated"})),stateManager.setReadOnly(!1)}async _saveAsTemplate(stateManager){await this.sendChange("save_as_template",stateManager)}async deleteCard(stateManager,cardId){await this.sendChange("delete_card",stateManager,{cardid:cardId})}async addCard(stateManager,columnId,afterCard){await this.sendChange("add_card",stateManager,{columnid:columnId,aftercard:afterCard})}async moveCard(stateManager,cardId,columnId,afterCard){await this.sendChange("move_card",stateManager,{cardid:cardId,columnid:columnId,aftercard:afterCard})}async deleteColumn(stateManager,columnId){await this.sendChange("delete_column",stateManager,{columnid:columnId})}async addColumn(stateManager,afterColumn){await this.sendChange("add_column",stateManager,{aftercol:afterColumn})}async moveColumn(stateManager,columnId,afterColumn){await this.sendChange("move_column",stateManager,{columnid:columnId,aftercol:afterColumn})}async assignUser(stateManager,cardId){let userId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;await this.sendChange("assign_user",stateManager,{cardid:cardId,userid:userId})}async completeCard(stateManager,cardId){await this.sendChange("set_card_complete",stateManager,{cardid:cardId,state:1})}async uncompleteCard(stateManager,cardId){await this.sendChange("set_card_complete",stateManager,{cardid:cardId,state:0})}async unassignUser(stateManager,cardId){let userId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;await this.sendChange("unassign_user",stateManager,{cardid:cardId,userid:userId})}async lockColumn(stateManager,columnId){await this.sendChange("set_column_locked",stateManager,{columnid:columnId,state:1})}async unlockColumn(stateManager,columnId){await this.sendChange("set_column_locked",stateManager,{columnid:columnId,state:0})}async lockColumns(stateManager){await this.sendChange("set_board_columns_locked",stateManager,{state:1})}async unlockColumns(stateManager){await this.sendChange("set_board_columns_locked",stateManager,{state:0})}async sendDiscussionMessage(stateManager,cardId,message){await this.sendChange("add_discussion_message",stateManager,{cardid:cardId,message:message})}async deleteMessage(stateManager,messageId){await this.sendChange("delete_discussion_message",stateManager,{messageid:messageId})}async sendChange(method,stateManager,data){const state=stateManager.state,result=await _ajax.default.call([{methodname:"mod_kanban_change_kanban_content_"+method,args:{cmid:state.common.id,boardid:state.board.id,data:data}}])[0];this.processUpdates(stateManager,result)}async getUpdates(stateManager){const state=stateManager.state,result=await _ajax.default.call([{methodname:"mod_kanban_get_kanban_content_update",args:{cmid:state.common.id,boardid:state.board.id,timestamp:state.common.timestamp}}])[0];this.processUpdates(stateManager,result)}async getDiscussionUpdates(stateManager,cardId){const state=stateManager.state;let timestamp=0;void 0!==state.discussions.get(cardId)&&state.discussions.get(cardId).values.forEach((discussion=>{void 0!==discussion.timestamp&&discussion.timestamp>timestamp&&(timestamp=discussion.timestamp)}));const result=await _ajax.default.call([{methodname:"mod_kanban_get_discussion_update",args:{cmid:state.common.id,boardid:state.board.id,cardid:cardId,timestamp:timestamp}}])[0];this.processUpdates(stateManager,result)}async processUpdates(stateManager,result){let updates=JSON.parse(result.update);stateManager.processUpdates(updates)}},_exports.default}));

//# sourceMappingURL=mutations.min.js.map