{"version":3,"file":"card.min.js","sources":["../src/card.js"],"sourcesContent":["import {BaseComponent, DragDrop} from 'core/reactive';\nimport selectors from 'mod_kanban/selectors';\nimport exporter from 'mod_kanban/exporter';\nimport {saveCancel} from 'core/notification';\nimport {get_string} from 'core/str';\n\n/**\n * Component representing a card in a kanban board.\n */\nexport default class extends BaseComponent {\n    /**\n     * Function to initialize component, called by mustache template.\n     * @param {*} target The id of the HTMLElement to attach to\n     * @returns {BaseComponent} New component attached to the HTMLElement represented by target\n     */\n    static init(target) {\n        let element = document.getElementById(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    /**\n     * Called after the component was created.\n     */\n    create() {\n        this.id = this.element.dataset.id;\n    }\n\n    /**\n     * Watchers for this component.\n     * @returns {array} All watchers for this component\n     */\n    getWatchers() {\n        return [\n            {watch: `cards[${this.id}]:updated`, handler: this._cardUpdated},\n            {watch: `cards[${this.id}]:deleted`, handler: this._cardDeleted},\n        ];\n    }\n\n    /**\n     * Called once when state is ready, attaching event listeners and initializing drag and drop.\n     * @param {*} state The initial state\n     */\n    stateReady(state) {\n        this.addEventListener(\n            this.getElement(selectors.DELETECARD, this.id),\n            'click',\n            this._removeConfirm\n        );\n        this.addEventListener(\n            this.getElement(selectors.ADDCARD, this.id),\n            'click',\n            this._addCard\n        );\n        this.addEventListener(\n            this.getElement(selectors.ASSIGNUSER, this.id),\n            'click',\n            this._assignUser\n        );\n        if (state.cards.get(this.id).assignees.length > 0) {\n            this.getElement(selectors.ASSIGNUSER, this.id).classList.add('mod_kanban_hidden');\n        }\n        this.draggable = false;\n        this.dragdrop = new DragDrop(this);\n        this.checkDragging(state);\n    }\n\n    /**\n     * Display confirmation modal for deleting a card.\n     * @param {*} event\n     */\n    _removeConfirm(event) {\n        saveCancel(\n            get_string('deletecard', 'mod_kanban'),\n            get_string('deletecardconfirm', 'mod_kanban'),\n            get_string('delete', 'core'),\n            () => {\n                this._removeCard(event);\n            }\n        );\n    }\n\n    /**\n     * Dispatch event to assign a user to the card.\n     * @param {*} event\n     */\n    _assignUser(event) {\n        let target = event.target.closest(selectors.ASSIGNUSER);\n        let data = Object.assign({}, target.dataset);\n        this.reactive.dispatch('assignUser', data.id);\n    }\n\n    /**\n     * Dispatch event to add a card after this card.\n     * @param {*} event\n     */\n    _addCard(event) {\n        let target = event.target.closest(selectors.ADDCARD);\n        let data = Object.assign({}, target.dataset);\n        this.reactive.dispatch('addCard', data.columnid, data.id);\n    }\n\n    /**\n     * Update this card.\n     * @param {*} param0\n     */\n    async _cardUpdated({element}) {\n        const card = this.getElement();\n        if (card.dataset.columnid != element.kanban_column) {\n            const col = document.querySelector(selectors.COLUMNINNER + '[data-id=\"' + element.kanban_column + '\"]');\n            col.appendChild(card);\n            this.getElement(selectors.ADDCARD, this.id).setAttribute('data-columnid', element.kanban_column);\n            card.setAttribute('data-columnid', element.kanban_column);\n        }\n        const assignees = this.getElement(selectors.ASSIGNEES, this.id);\n        const assignedUsers = this.getElements(selectors.ASSIGNEDUSER, this.id);\n        const userids = [...assignedUsers].map(v => {\n            return v.dataset.userid;\n        });\n        const additional = element.assignees.filter(x => !userids.includes(x));\n        if (assignedUsers !== null) {\n            assignedUsers.forEach(assignedUser => {\n                if (!element.assignees.includes(assignedUser.dataset.userid)) {\n                    assignedUser.parentNode.removeChild(assignedUser);\n                }\n            });\n        }\n        if (element.assignees.length > 0) {\n            additional.forEach(async user => {\n                let placeholder = document.createElement('div');\n                let userdata = this.reactive.state.users.get(user);\n                let data = Object.assign({cardid: element.id}, userdata);\n                data = Object.assign(data, exporter.exportCapabilities(this.reactive.state));\n                placeholder.setAttribute('data-id', element.id);\n                placeholder.setAttribute('data-action', 'unassign_user');\n                assignees.appendChild(placeholder);\n                const newcomponent = await this.renderComponent(placeholder, 'mod_kanban/user', data);\n                const newelement = newcomponent.getElement();\n                assignees.replaceChild(newelement, placeholder);\n                assignees.appendChild(this.getElement(selectors.ASSIGNUSER, this.id));\n            });\n            this.getElement(selectors.ASSIGNUSER, this.id).classList.add('mod_kanban_hidden');\n        } else {\n            this.getElement(selectors.ASSIGNUSER, this.id).classList.remove('mod_kanban_hidden');\n        }\n        this.checkDragging();\n    }\n\n    /**\n     * Delete this card.\n     */\n    _cardDeleted() {\n        const el = this.getElement();\n        el.parentNode.removeChild(el);\n        this.destroy();\n    }\n\n    /**\n     * Dispatch event to remove this card.\n     * @param {*} event\n     */\n    _removeCard(event) {\n        let target = event.target.closest('[data-action=\"delete_card\"]');\n        let data = Object.assign({}, target.dataset);\n        this.reactive.dispatch('deleteCard', data.id);\n    }\n\n    /**\n     * Remove all subcomponents dependencies.\n     */\n    destroy() {\n        if (this.dragdrop !== undefined) {\n            this.dragdrop.unregister();\n        }\n    }\n\n    /**\n     * Get the draggable data of this component.\n     * @returns {object}\n     */\n    getDraggableData() {\n        return {\n            id: this.id,\n            type: 'card',\n        };\n    }\n\n    /**\n     * Conditionally enable / disable dragging.\n     * @param {*} state\n     */\n    checkDragging(state) {\n        if (state === undefined) {\n            state = this.reactive.stateManager.state;\n        }\n        if (state.capabilities.get('moveallcards').value ||\n            (state.capabilities.get('moveassignedcards').value &&\n            state.cards.get(this.id).assignees.includes(state.board.userid))) {\n            this.draggable = true;\n            this.dragdrop.setDraggable(true);\n\n        } else {\n            this.draggable = false;\n            this.dragdrop.setDraggable(false);\n        }\n    }\n\n    /**\n     * Validate draggable data.\n     * @param {object} dropdata\n     * @returns {boolean} if the data is valid for this drop-zone.\n     */\n    validateDropData(dropdata) {\n        return dropdata?.type == 'card';\n    }\n\n    /**\n     * Executed when a valid dropdata is dropped over the drop-zone.\n     * @param {object} dropdata\n     */\n    drop(dropdata) {\n        if (dropdata.id != this.id) {\n            let newcolumn = this.getElement(selectors.ADDCARD, this.id).dataset.columnid;\n            let aftercard = this.id;\n            this.reactive.dispatch('moveCard', dropdata.id, newcolumn, aftercard);\n        }\n    }\n}\n"],"names":["BaseComponent","target","this","element","document","getElementById","create","id","dataset","getWatchers","watch","handler","_cardUpdated","_cardDeleted","stateReady","state","addEventListener","getElement","selectors","DELETECARD","_removeConfirm","ADDCARD","_addCard","ASSIGNUSER","_assignUser","cards","get","assignees","length","classList","add","draggable","dragdrop","DragDrop","checkDragging","event","_removeCard","closest","data","Object","assign","reactive","dispatch","columnid","card","kanban_column","querySelector","COLUMNINNER","appendChild","setAttribute","ASSIGNEES","assignedUsers","getElements","ASSIGNEDUSER","userids","map","v","userid","additional","filter","x","includes","forEach","assignedUser","parentNode","removeChild","async","placeholder","createElement","userdata","users","user","cardid","exporter","exportCapabilities","newelement","renderComponent","replaceChild","remove","el","destroy","undefined","unregister","getDraggableData","type","stateManager","capabilities","value","board","setDraggable","validateDropData","dropdata","drop","newcolumn","aftercard"],"mappings":"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"}